class Connection{static ACTIVE="#d4f2ff";static SELECTED="#35b7f0";static NOT_SELECTED="#000000";static POINT_RADIUS=3.5;constructor(t,s){this.c1=t,this.c2=s,this.points=[],this.state=Connection.NOT_SELECTED}show(){strokeWeight(2),stroke(this.state);var s=[{x:this.c1.x,y:this.c1.y,over:!1},...this.points,{x:this.c2.x,y:this.c2.y,over:!1}];for(let t=1;t<s.length;t++){var e=s[t-1],i=s[t];line(e.x,e.y,i.x,i.y),i.over?fill("#FF0000"):fill(this.state),noStroke(),circle(i.x,i.y,2*Connection.POINT_RADIUS),strokeWeight(2),stroke(this.state)}stroke("#000000"),strokeWeight(1)}addPoint(t,s){t={x:t,y:s,over:!1},s=this.findInterval();1==s?this.points=[t,...this.points]:s==this.points.length+1?this.points.push(t):this.points.splice(s-1,0,t)}mouseOverConnectionPoint(){for(var t of this.points)dist(t.x,t.y,mouseX,mouseY)<Connection.POINT_RADIUS?t.over=!0:t.over=!1}mouseDragged(){for(var t of this.points)if(t.over)return t.x=mouseX,t.y=mouseY,t;return null}adjust(t,s){for(var e of this.points)e.over&&(e.x=t,e.y=s)}findInterval(){var s=[{x:this.c1.x,y:this.c1.y},...this.points,{x:this.c2.x,y:this.c2.y}];for(let t=1;t<s.length;t++){var e=s[t-1],i=s[t];if(this.isPointOverLine(e.x,e.y,i.x,i.y,mouseX,mouseY))return t}}mouseOver(){return this.mouseOverConnectionPoint(),this.isOverConnection()?(this.state=Connection.ACTIVE,this.over=!0):(this.state=Connection.NOT_SELECTED,this.over=!1),this.over}isOverConnection(){let t=this.c1;for(var s of this.points){if(this.isOverLine(t.x,t.y,s.x,s.y))return!0;t=s}return!!this.isOverLine(t.x,t.y,this.c2.x,this.c2.y)}isOverLine(t,s,e,i){return this.isPointOverLine(t,s,e,i,mouseX,mouseY)}isPointOverLine(t,s,e,i,o,n){return dist(t,s,o,n)+dist(e,i,o,n)-dist(t,s,e,i)<.08}equals(t){return this.c1.x==t.c1.x&&this.c1.y==t.c1.y&&this.c2.x==t.c2.x&&this.c2.y==t.c2.y||this.c1.x==t.c2.x&&this.c1.y==t.c2.y&&this.c2.x==t.c1.x&&this.c2.y==t.c1.y}}class ConnectionPoint{}class Connector{static ACTIVE="#d4f2ff";static SELECTED="#35b7f0";static NOT_SELECTED="#FFFFFF";constructor(t,s,e){this.x=t,this.y=s,this.r=e,this.connected=!1,this.value=!1,this.state=Connector.NOT_SELECTED,this.over=!1,this.connections=[]}addConnection(t){this.connections.push(t),this.propagate()}setValue(t){this.connected=!0,this.value=t,this.propagate()}propagate(){this.connections.forEach(t=>{this.equals(t.c1)||t.c1.setValue(this.value),this.equals(t.c2)||t.c2.setValue(this.value)})}equals(t){return this.x==t.x&&this.y==t.y}mouseOver(){return dist(this.x,this.y,mouseX,mouseY)<this.r?(this.state=Connector.ACTIVE,this.over=!0):(this.state=Connector.NOT_SELECTED,this.over=!1),this.over}mousePressed(){this.over&&(this.state=Connector.SELECTED)}mouseDragged(){return this.over?(this.x=mouseX,this.y=mouseY,this):null}mouseReleased(){this.over?this.state=Connector.ACTIVE:this.state=Connector.NOT_SELECTED}show(){fill(this.state),circle(this.x,this.y,2*this.r),fill(this.value&&this.connected?"rgba(255, 170, 0, 0.4)":"rgba(255, 255, 255, 0.6)"),circle(this.x,this.y,2*this.r)}}class Constant extends Connector{constructor(t,s,e){super(t,s,10),this.value=e}show(){super.show(),fill(0),textSize(14),textAlign(CENTER,CENTER),strokeWeight(1),text(this.value?"1":"0",this.x,this.y)}}class Movable{static ACTIVE="#d4f2ff";static SELECTED="#35b7f0";static NOT_SELECTED="#FFFFFF";constructor(t,s){this.x=t,this.y=s,this.mouseOffset={x:0,y:0},this.state=Movable.NOT_SELECTED,this.over=!1,this.isDragged=!1}mousePressed(){this.over&&(this.state=Movable.SELECTED)}mouseDragged(){this.over&&(this.isDragged=!0,this.x=mouseX,this.y=mouseY)}mouseOver(){this.isDragged&&(this.mouseOffset={x:mouseX-this.x,y:mouseY-this.y})}mouseReleased(){this.isDragged=!1,this.over?this.state=Movable.ACTIVE:this.state=Movable.NOT_SELECTED}}class Port extends Movable{constructor(t,s,e,...i){super(t,s),this.size=35,this.connectorSize=5,"NOT"==(this.type=e)?(this.in1=i[0],this.out=i[1],(this.in1.port=this).out.port=this):(this.in1=i[0],this.in2=i[1],this.out=i[2],((this.in1.port=this).in2.port=this).out.port=this),"NOT"==e?this.in1.r=this.connectorSize:(this.in1.r=this.connectorSize,this.in2.r=this.connectorSize),this.out.r=this.connectorSize,this.updateConnectorsPositions()}getConnectorPositions(){return"NOT"==this.type?{c1:{x:this.x-20,y:this.y+this.size/2},c2:{x:this.x+this.size+20,y:this.y+this.size/2}}:{c1:{x:this.x-20,y:this.y+this.size/4},c2:{x:this.x-20,y:this.y+this.size/4*3},c3:{x:this.x+this.size+20,y:this.y+this.size/4*2}}}updateConnectorsPositions(){var t=this.getConnectorPositions();this.in1.x=t.c1.x,this.in1.y=t.c1.y,"NOT"==this.type?(this.out.x=t.c2.x,this.out.y=t.c2.y):(this.in2.x=t.c2.x,this.in2.y=t.c2.y,this.out.x=t.c3.x,this.out.y=t.c3.y)}mouseOver(){return super.mouseOver(),this.isMouseOver()?(this.state=Connector.ACTIVE,this.over=!0):(this.state=Connector.NOT_SELECTED,this.over=!1),this.over}isMouseOver(){return this.x<mouseX&&mouseX<this.x+this.size&&this.y<mouseY&&mouseY<this.y+this.size}mouseDragged(){this.over&&(this.isDragged=!0,this.x=mouseX-this.mouseOffset.x,this.y=mouseY-this.mouseOffset.y,this.updateConnectorsPositions())}and(){rect(this.x,this.y,this.size/2,this.size),arc(this.x+this.size/2-1,this.y+this.size/2,this.size,this.size,HALF_PI+PI,HALF_PI)}not(){triangle(this.x,this.y,this.x,this.y+this.size,this.x+this.size-10,this.y+this.size/2),circle(this.x+this.size-5,this.y+this.size/2,10)}or(){beginShape(),vertex(this.x,this.y),bezierVertex(this.x+10,this.y+this.size/6,this.x+10,this.y+this.size/6*5,this.x,this.y+this.size),bezierVertex(this.x,this.y+this.size,this.x+this.size/6*5,this.y+this.size,this.x+this.size+5,this.y+this.size/2),bezierVertex(this.x+this.size+5,this.y+this.size/2,this.x+this.size/6*5,this.y,this.x,this.y),endShape()}show(){push(),fill(this.state),strokeWeight(2);var t=this.getConnectorPositions();"NOT"==this.type?(line(t.c1.x,t.c1.y,t.c1.x+30,t.c1.y),line(t.c2.x,t.c2.y,t.c2.x-20,t.c2.y)):(line(t.c1.x,t.c1.y,t.c1.x+30,t.c1.y),line(t.c2.x,t.c2.y,t.c2.x+30,t.c2.y),line(t.c3.x,t.c3.y,t.c3.x-20,t.c3.y)),"AND"==this.type?this.and():"OR"==this.type?this.or():"NOT"==this.type?this.not():"NAND"==this.type&&(this.and(),circle(t.c3.x-15,t.c3.y,2*this.connectorSize)),fill(255),this.in1.show(),"NOT"!=this.type&&this.in2.show(),this.out.show(),pop()}calculateOutput(){return!!(this.in1.connected&&this.in2&&this.in2.connected)&&("AND"==this.type?this.in1.value&&this.in2.value:"NAND"==this.type?!(this.in1.value&&this.in2.value):"OR"==this.type?this.in1.value||this.in2.value:"NOT"==this.type?!this.in1.value:void 0)}update(){var t=this.calculateOutput();this.out.setValue(t)}equals(t){return this.x==t.x&&this.y==t.y&&this.type==t.type}}class PortConnector extends Connector{static IN=0;static OUT=1;constructor(t,s,e,i){super(t,s,e),this.port=null,this.type=i}setValue(t){super.setValue(t),this.type==PortConnector.IN&&this.port.update()}mouseDragged(){return null}}class Switch extends Connector{static ON="#FF0000";static OFF="#FFFFFF";constructor(t,s){super(t,s,10),this.value=!1}show(){super.show(),fill(this.value?Switch.ON:Switch.OFF),circle(this.x,this.y,12)}mouseClicked(){this.setValue(!this.value)}adjust(t,s){this.over&&(this.x=t,this.y=s)}}let items=[],connectors=[],connections=[],startConnection,nowDrawing=0,guide,mouseState,itemDragged,showGuide=!1,ports=["CONNECTOR","SWITCH","AND","OR","NOT","NAND","CONST1","CONST0"];function setup(){createCanvas(windowWidth,windowHeight),guide=createVector(width/2,height/2),frameRate(120),document.getElementById("btnConn").addEventListener("click",t=>nowDrawing=0),document.getElementById("btnSwitch").addEventListener("click",t=>nowDrawing=1),document.getElementById("btnAnd").addEventListener("click",t=>nowDrawing=2),document.getElementById("btnOr").addEventListener("click",t=>nowDrawing=3),document.getElementById("btnNot").addEventListener("click",t=>nowDrawing=4),document.getElementById("btnNand").addEventListener("click",t=>nowDrawing=5)}function draw(){background(220),connections.forEach(t=>t.show()),connectors.forEach(t=>t.show()),items.forEach(t=>t.show()),startConnection&&line(startConnection.x,startConnection.y,mouseX,mouseY),showGuide&&(fill("rgba(0, 0, 255, 0.4)"),noStroke(),circle(guide.x,guide.y,30),stroke(150),line(guide.x,0,guide.x,height),line(0,guide.y,width,guide.y),stroke(0))}function createPort(t,s,e){var i,o,n;"NOT"==e?(i=new PortConnector(0,0,0,PortConnector.IN),o=new PortConnector(0,0,0,PortConnector.OUT),connectors.push(i,o),n=new Port(t,s,"NOT",i,o),i.port=n,o.port=n,items.push(n)):"CONNECTOR"==e?connectors.push(new Connector(t,s,10)):"SWITCH"==e?connectors.push(new Switch(t,s)):(i=new PortConnector(0,0,0,PortConnector.IN),o=new PortConnector(0,0,0,PortConnector.IN),n=new PortConnector(0,0,0,PortConnector.OUT),connectors.push(i,o,n),t=new Port(t,s,e,i,o,n),i.port=t,o.port=t,n.port=t,items.push(t))}function mouseClicked(){for(var t of connectors)if(t.mouseOver())if(startConnection){let s=new Connection(startConnection,t);if(!connections.some(t=>t.equals(s)))return startConnection instanceof PortConnector?t instanceof Switch?(t.addConnection(s),connections.push(s)):t instanceof PortConnector&&(t.port.equals(startConnection.port)||(print("portas diferentes"),t.type!=startConnection.type&&(t.type==PortConnector.IN?(startConnection.addConnection(s),connections.push(s)):t.type==PortConnector.OUT&&(t.addConnection(s),connections.push(s))))):startConnection instanceof Switch&&t instanceof PortConnector&&(startConnection.addConnection(s),connections.push(s)),void(startConnection=null)}else t.mouseClicked&&t.mouseClicked();startConnection=null}function doubleClicked(){for(var t of connectors)if(t.mouseOver())return void(startConnection=t);for(var s of connections)if(s.mouseOver())return void s.addPoint(mouseX,mouseY);"CONST0"==ports[nowDrawing]?connectors.push(new Constant(mouseX,mouseY,!1)):"CONST1"==ports[nowDrawing]?connectors.push(new Constant(mouseX,mouseY,!0)):createPort(mouseX,mouseY,ports[nowDrawing])}function mouseMoved(){var t;for(t of[...connectors,...items])if(t.mouseOver())return;connections.forEach(t=>t.mouseOver())}function mousePressed(){mouseState="pressed";for(var t of connectors)if(t.mousePressed())return}function mouseReleased(){var t=mouseState;mouseState="released",connectors.forEach(t=>t.mouseReleased()),"dragged"==t&&"released"==mouseState&&-1<guide.x&&-1<guide.y&&dist(mouseX,mouseY,guide.x,guide.y)<15&&(connections.forEach(t=>t.adjust(guide.x,guide.y)),connectors.forEach(t=>{t.adjust&&t.adjust(guide.x,guide.y)}))}function mouseDragged(){mouseState="dragged";let s;var t;showGuide=!1;for(t of[...connectors,...connections,...items])if(t.mouseDragged()){s=t;break}s instanceof Connection?connectors.forEach(s=>{connectors.forEach(t=>{abs(s.x-mouseX)<10&&abs(t.y-mouseY)<10?(guide.x=s.x,guide.y=t.y,showGuide=!0):abs(t.x-mouseX)<10&&abs(s.y-mouseY)<10&&(guide.x=t.x,guide.y=s.y,showGuide=!0)})}):s instanceof Connector&&connectors.filter(t=>!t.equals(s)).forEach(t=>{abs(t.x-mouseX)<10?(guide.x=t.x,guide.y=mouseY,showGuide=!0):abs(t.y-mouseY)<10&&(guide.x=mouseX,guide.y=t.y,showGuide=!0)})}function keyPressed(){32==keyCode&&(nowDrawing=(nowDrawing+1)%ports.length)}